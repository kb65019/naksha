<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم نكشة | الإصدار النهائي</title>
    <style>
        :root {
            --primary: #27ae60;
            --danger: #e74c3c;
            --dark: #8B0000;
            --bg: #8B0000;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* شاشة القفل */
        #login-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--dark);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .login-box {
            background: white;
            padding: 30px;
            border-radius: 50px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
            width: 90%;
            max-width: 350px;
        }

        .login-box input {
            width: 100%; padding: 12px; margin-bottom: 15px;
            border: 1px solid #ddd; border-radius: 50px;
            text-align: center; font-size: 1.1rem; outline: none;
        }

        .login-box button {
            width: 100%; padding: 12px; background: var(--primary);
            color: white; border: none; border-radius: 50px;
            cursor: pointer; font-weight: bold; font-size: 1rem;
        }

        /* محتوى لوحة التحكم */
        #admin-content {
            display: none;
            width: 100%;
            max-width: 600px;
            padding: 20px;
        }

        .admin-container {
            background: white;
            padding: 25px;
            border-radius: 50px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        h1 { text-align: center; color: var(--dark); margin-bottom: 20px; }

        .bulk-control {
            background: #fdf2f2;
            padding: 15px 20px;
            border-radius: 30px;
            margin-bottom: 20px;
            border: 2px solid var(--danger);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .product-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .product-name { font-weight: bold; font-size: 1.1rem; color: #333; }

        /* Switch Styling */
        .switch { position: relative; display: inline-block; width: 55px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 50px;
        }
        .slider:before {
            position: absolute; content: "";
            height: 20px; width: 20px;
            left: 4px; bottom: 4px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(27px); }

        /* Confirm Box */
        #custom-confirm {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .confirm-box {
            background: white;
            padding: 30px;
            border-radius: 40px;
            text-align: center;
            max-width: 320px;
            width: 85%;
        }

        .confirm-btns { display: flex; gap: 10px; margin-top: 20px; }
        .confirm-btns button {
            flex: 1; padding: 12px; border: none; border-radius: 50px;
            cursor: pointer; font-weight: bold;
        }
        .btn-yes { background: var(--primary); color: white; }
        .btn-no { background: #eee; color: #333; }

        .logout-btn {
            display: block; width: 100%; margin-top: 20px;
            padding: 10px; background: #95a5a6; color: white;
            border: none; border-radius: 50px; cursor: pointer;
        }
    </style>
</head>
<body>

<div id="custom-confirm">
    <div class="confirm-box">
        <h3 id="confirm-msg">هل أنت متأكد؟</h3>
        <p>سيتم تعديل حالة جميع الأصناف في القائمة.</p>
        <div class="confirm-btns">
            <button class="btn-yes" id="confirm-btn-yes">نعم، تنفيذ</button>
            <button class="btn-no" id="confirm-btn-no">إلغاء</button>
        </div>
    </div>
</div>

<div id="login-overlay">
    <div class="login-box">
        <h2>دخول الإدارة</h2>
        <input type="password" id="admin-pass" placeholder="أدخل كلمة السر">
        <button onclick="checkPass()">دخول</button>
        <p id="error-msg" style="color: var(--danger); display: none; margin-top: 10px;">كلمة السر خاطئة!</p>
    </div>
</div>

<div id="admin-content">
    <div class="admin-container">
        <h1>إدارة مطعم نكشة</h1>

        <div class="bulk-control">
            <span style="font-weight: bold; color: var(--dark);">تحكم كامل بالأصناف</span>
            <label class="switch">
                <input type="checkbox" id="master-toggle" onchange="askForToggleAll(this.checked)">
                <span class="slider"></span>
            </label>
        </div>

        <div id="admin-list">جاري تحميل البيانات...</div>

        <button class="logout-btn" onclick="location.reload()">تسجيل خروج</button>

        <center style="margin-top: 20px; font-size: 0.8rem; color: #777;">
            <h4>Developed and Designed by khaled badran</h4>
        </center>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    const SECRET_PASSWORD = "1920";
    const SB_URL = 'https://nxcjnxtvkacsaiikglhy.supabase.co';
    const SB_KEY = 'sb_publishable_AbkphcROGqeua_aCIc_fAA_b8KNnYRh';
    const sb = supabase.createClient(SB_URL, SB_KEY);

    let isUpdatingAll = false; // متغير لمنع التعليق أثناء التحديث الجماعي

    document.getElementById('admin-pass').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') checkPass();
    });

    function checkPass() {
        const pass = document.getElementById('admin-pass').value;
        if (pass === SECRET_PASSWORD) {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('admin-content').style.display = 'block';
            loadAdminMenu();
            listenToChanges();
        } else {
            document.getElementById('error-msg').style.display = 'block';
        }
    }

    async function loadAdminMenu() {
        if (isUpdatingAll) return; // منع إعادة التحميل أثناء العملية الكبرى
        const { data, error } = await sb.from('inventory').select('*').order('product_name');
        if (error) return;
        renderList(data);
    }

    function renderList(data) {
        const listContainer = document.getElementById('admin-list');
        listContainer.innerHTML = '';
        let allActive = data.length > 0;

        data.forEach((item) => {
            const isAvailable = item.status === "yes";
            if (!isAvailable) allActive = false;

            const row = document.createElement('div');
            row.className = 'product-row';
            row.innerHTML = `
                <span class="product-name">${item.product_name}</span>
                <label class="switch">
                    <input type="checkbox" ${isAvailable ? 'checked' : ''}
                        onchange="toggleStatus('${item.product_name}', this.checked)">
                    <span class="slider"></span>
                </label>`;
            listContainer.appendChild(row);
        });

        // تحديث حالة السويتش الرئيسي بدون تفعيل الـ onchange الخاص به
        const masterToggle = document.getElementById('master-toggle');
        masterToggle.onclick = null; // تعطيل مؤقت
        masterToggle.checked = allActive;
        masterToggle.onclick = function() { askForToggleAll(this.checked); };
    }

    async function toggleStatus(pName, isChecked) {
        const newStatus = isChecked ? "yes" : "no";
        const { error } = await sb.from('inventory').update({ status: newStatus }).eq('product_name', pName);
        if (error) alert("خطأ في التحديث: " + error.message);
    }

    function listenToChanges() {
        sb.channel('admin_realtime')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'inventory' }, () => {
              loadAdminMenu();
          }).subscribe();
    }

    let pendingState = false;
    function askForToggleAll(isChecked) {
        pendingState = isChecked;
        document.getElementById('confirm-msg').innerText = isChecked ? "فتح جميع الأصناف؟" : "إغلاق جميع الأصناف؟";
        document.getElementById('custom-confirm').style.display = 'flex';
    }

    // زر "نعم" للتحديث الجماعي
    document.getElementById('confirm-btn-yes').onclick = async function() {
        document.getElementById('custom-confirm').style.display = 'none';
        isUpdatingAll = true; // تفعيل وضع التحديثf
        const newStatus = pendingState ? "yes" : "no";

        // تحديث كل الصفوف - نستخدم شرط لا يخطئ مثل 'neq' لـ id غير موجود أو 'not.is'
        const { error } = await sb
            .from('inventory')
            .update({ status: newStatus })
            .neq('product_name', 'bogus_item_name'); // شرط يضمن اختيار الجميع

        if (error) {
            alert("فشل التحديث الجماعي: " + error.message);
        }

        isUpdatingAll = false;
        loadAdminMenu();
    };

    document.getElementById('confirm-btn-no').onclick = function() {
        document.getElementById('custom-confirm').style.display = 'none';
        loadAdminMenu(); // إعادة حالة السويتش لما كانت عليه
    };
</script>
</body>
</html>
